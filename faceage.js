import * as THREE from "three";
import { MindARThree } from 'mindar-face-three';
import * as faceapi from "face-api";

document.addEventListener("DOMContentLoaded", () => {

	const start = async() => {
	      const mindarThree = new MindARThree({
			container: document.body,
			uiLoading: "yes", uiScanning: "no", uiError: "no",
      		});

	        const {renderer, scene, camera} = mindarThree;

		await faceapi.nets.ssdMobilenetv1.load("assets/face-api-model/");
		await faceapi.nets.tinyFaceDetector.load("assets/face-api-model/");
		await faceapi.nets.faceLandmark68Net.load("assets/face-api-model/");
		await faceapi.nets.faceExpressionNet.load("assets/face-api-model/");
		await faceapi.nets.ageGenderNet.load("assets/face-api-model/");

		// faceLandmark68TinyNet
		// faceRecognitionNet
		// ssdMobilenetv1
		// tinyYolov2

		const expr = [
			"neutral",
			"happy",
			"sad",
			"angry",
			"fearful",
			"disgusted",
			"surprised"
		];

		const div_info=document.getElementById("info");

		await mindarThree.start();

		let skipper = 0;

		const video = mindarThree.video;

		renderer.setAnimationLoop(async () => {
			if(skipper%5==0)
			{
				const result = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceExpressions().withAgeAndGender();
				if(result)
				{
					let str="Стать ";
					if(result["gender"]=="male")
						str+="чоловіча";
					else
						str+="жіноча";
					str+=" (з імовірністю " + Math.round(100*result["genderProbability"])+"%)<br>";
					str+="Вік - "+Math.round(result["age"])+ " років<br>";

					let emotion = "neutral";
					let max_prob = result["expressions"][emotion];

					for(let i=0;i<expr.length;i++)
					{
						//console.log(expr[i], result["expressions"][expr[i]]);
						if(result["expressions"][expr[i]]>max_prob)
						{
							max_prob = result["expressions"][expr[i]];
							emotion = expr[i];
						}
					}
					str+=emotion + " (з імовірністю " + Math.round(100*max_prob)+"%)<br>";
					div_info.innerHTML = str;
				}
			}
			skipper++;
		  	renderer.render(scene, camera);
		});

	}
	start();
});

/*
{
    "detection": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9959298968315125,
        "_classScore": 0.9959298968315125,
        "_className": "",
        "_box": {
            "_x": 260.1080513000488,
            "_y": 161.51683807373044,
            "_width": 220.45835494995117,
            "_height": 255.5390930175781
        }
    },
    "landmarks": {
        "_imgDims": {
            "_width": 220,
            "_height": 255
        },
        "_shift": {
            "_x": 260.1080513000488,
            "_y": 161.51683807373044
        },
        "_positions": [
            {
                "_x": 252.03597582876682,
                "_y": 242.2024609148502
            },
            {
                "_x": 255.0112123042345,
                "_y": 272.81299516558647
            },
            {
                "_x": 259.4940313883126,
                "_y": 299.7163799405098
            },
            {
                "_x": 264.1230332106352,
                "_y": 322.00498074293137
            },
            {
                "_x": 272.31918655335903,
                "_y": 346.7996382713318
            },
            {
                "_x": 287.11713418364525,
                "_y": 367.98442870378494
            },
            {
                "_x": 304.8267275094986,
                "_y": 384.30459856987
            },
            {
                "_x": 329.260955452919,
                "_y": 402.45395988225937
            },
            {
                "_x": 365.0820595026016,
                "_y": 412.4533209204674
            },
            {
                "_x": 399.9865698814392,
                "_y": 403.082035779953
            },
            {
                "_x": 424.24010038375854,
                "_y": 387.24594473838806
            },
            {
                "_x": 442.66300439834595,
                "_y": 371.40027821063995
            },
            {
                "_x": 459.1612446308136,
                "_y": 348.3733466267586
            },
            {
                "_x": 469.9228000640869,
                "_y": 322.791188955307
            },
            {
                "_x": 475.4741322994232,
                "_y": 298.3852809667587
            },
            {
                "_x": 480.0042223930359,
                "_y": 272.57476314902306
            },
            {
                "_x": 480.6779956817627,
                "_y": 243.41543942689893
            },
            {
                "_x": 275.3968480229378,
                "_y": 235.24783089756963
            },
            {
                "_x": 289.24057334661484,
                "_y": 231.16460040211675
            },
            {
                "_x": 305.53268015384674,
                "_y": 231.70602574944493
            },
            {
                "_x": 321.16915225982666,
                "_y": 233.65457639098165
            },
            {
                "_x": 334.8039674758911,
                "_y": 238.77372249960897
            },
            {
                "_x": 389.6560263633728,
                "_y": 239.91350933909413
            },
            {
                "_x": 402.8969132900238,
                "_y": 235.62036290764806
            },
            {
                "_x": 418.90748023986816,
                "_y": 233.32075670361516
            },
            {
                "_x": 437.12520480155945,
                "_y": 234.55911025404927
            },
            {
                "_x": 451.2108588218689,
                "_y": 238.67989033460614
            },
            {
                "_x": 361.82278513908386,
                "_y": 269.52404364943504
            },
            {
                "_x": 362.16133058071136,
                "_y": 291.1851841211319
            },
            {
                "_x": 361.2949728965759,
                "_y": 311.7491486668587
            },
            {
                "_x": 360.4226750135422,
                "_y": 328.3675265312195
            },
            {
                "_x": 343.72820496559143,
                "_y": 328.6190730333328
            },
            {
                "_x": 351.38093173503876,
                "_y": 333.1212842464447
            },
            {
                "_x": 362.30467557907104,
                "_y": 336.2849032878876
            },
            {
                "_x": 373.46670269966125,
                "_y": 333.11591893434525
            },
            {
                "_x": 381.78025364875793,
                "_y": 329.756640791893
            },
            {
                "_x": 297.3890805244446,
                "_y": 256.70029416680336
            },
            {
                "_x": 307.7185848355293,
                "_y": 256.3363040983677
            },
            {
                "_x": 321.0823178291321,
                "_y": 255.922574698925
            },
            {
                "_x": 333.581525683403,
                "_y": 261.60058721899986
            },
            {
                "_x": 322.74394094944,
                "_y": 265.71846425533295
            },
            {
                "_x": 308.2726952433586,
                "_y": 263.8178290426731
            },
            {
                "_x": 391.8611514568329,
                "_y": 262.709481716156
            },
            {
                "_x": 404.6996259689331,
                "_y": 257.61988282203674
            },
            {
                "_x": 419.2881774902344,
                "_y": 258.1462533771992
            },
            {
                "_x": 429.36657071113586,
                "_y": 260.80316960811615
            },
            {
                "_x": 418.5211443901062,
                "_y": 267.46737360954285
            },
            {
                "_x": 403.6826193332672,
                "_y": 266.3658659160137
            },
            {
                "_x": 319.73048985004425,
                "_y": 351.05486273765564
            },
            {
                "_x": 334.74318861961365,
                "_y": 351.13341212272644
            },
            {
                "_x": 353.3876436948776,
                "_y": 350.54190546274185
            },
            {
                "_x": 362.84624338150024,
                "_y": 352.4969309568405
            },
            {
                "_x": 371.436767578125,
                "_y": 350.2375113964081
            },
            {
                "_x": 392.42727994918823,
                "_y": 352.9723918437958
            },
            {
                "_x": 408.2582902908325,
                "_y": 353.2971528172493
            },
            {
                "_x": 391.28333926200867,
                "_y": 367.17001080513
            },
            {
                "_x": 377.88660407066345,
                "_y": 374.12752866744995
            },
            {
                "_x": 362.8999412059784,
                "_y": 375.895437002182
            },
            {
                "_x": 349.83920097351074,
                "_y": 374.00850385427475
            },
            {
                "_x": 334.8911887407303,
                "_y": 366.9633474946022
            },
            {
                "_x": 321.75885140895844,
                "_y": 351.8282276391983
            },
            {
                "_x": 348.64109694957733,
                "_y": 356.200136244297
            },
            {
                "_x": 362.7227908372879,
                "_y": 357.1766382455826
            },
            {
                "_x": 376.66099548339844,
                "_y": 357.0235824584961
            },
            {
                "_x": 405.25753259658813,
                "_y": 353.2755395770073
            },
            {
                "_x": 376.8331038951874,
                "_y": 362.8285613656044
            },
            {
                "_x": 363.4547859430313,
                "_y": 364.55599427223206
            },
            {
                "_x": 350.56989789009094,
                "_y": 363.1965032219887
            }
        ]
    },
    "unshiftedLandmarks": {
        "_imgDims": {
            "_width": 220,
            "_height": 255
        },
        "_shift": {
            "_x": 0,
            "_y": 0
        },
        "_positions": [
            {
                "_x": -8.072075471282005,
                "_y": 80.68562284111977
            },
            {
                "_x": -5.096838995814323,
                "_y": 111.296157091856
            },
            {
                "_x": -0.6140199117362499,
                "_y": 138.19954186677933
            },
            {
                "_x": 4.014981910586357,
                "_y": 160.4881426692009
            },
            {
                "_x": 12.211135253310204,
                "_y": 185.28280019760132
            },
            {
                "_x": 27.00908288359642,
                "_y": 206.46759063005447
            },
            {
                "_x": 44.71867620944977,
                "_y": 222.78776049613953
            },
            {
                "_x": 69.15290415287018,
                "_y": 240.9371218085289
            },
            {
                "_x": 104.9740082025528,
                "_y": 250.9364828467369
            },
            {
                "_x": 139.87851858139038,
                "_y": 241.56519770622253
            },
            {
                "_x": 164.13204908370972,
                "_y": 225.7291066646576
            },
            {
                "_x": 182.55495309829712,
                "_y": 209.88344013690948
            },
            {
                "_x": 199.05319333076477,
                "_y": 186.8565085530281
            },
            {
                "_x": 209.8147487640381,
                "_y": 161.27435088157654
            },
            {
                "_x": 215.3660809993744,
                "_y": 136.86844289302826
            },
            {
                "_x": 219.89617109298706,
                "_y": 111.05792507529259
            },
            {
                "_x": 220.56994438171387,
                "_y": 81.89860135316849
            },
            {
                "_x": 15.288796722888947,
                "_y": 73.73099282383919
            },
            {
                "_x": 29.13252204656601,
                "_y": 69.6477623283863
            },
            {
                "_x": 45.42462885379791,
                "_y": 70.18918767571449
            },
            {
                "_x": 61.06110095977783,
                "_y": 72.1377383172512
            },
            {
                "_x": 74.69591617584229,
                "_y": 77.25688442587852
            },
            {
                "_x": 129.54797506332397,
                "_y": 78.3966712653637
            },
            {
                "_x": 142.78886198997498,
                "_y": 74.10352483391762
            },
            {
                "_x": 158.79942893981934,
                "_y": 71.80391862988472
            },
            {
                "_x": 177.01715350151062,
                "_y": 73.04227218031883
            },
            {
                "_x": 191.10280752182007,
                "_y": 77.1630522608757
            },
            {
                "_x": 101.71473383903503,
                "_y": 108.00720557570457
            },
            {
                "_x": 102.05327928066254,
                "_y": 129.66834604740143
            },
            {
                "_x": 101.1869215965271,
                "_y": 150.2323105931282
            },
            {
                "_x": 100.31462371349335,
                "_y": 166.850688457489
            },
            {
                "_x": 83.6201536655426,
                "_y": 167.10223495960236
            },
            {
                "_x": 91.27288043498993,
                "_y": 171.60444617271423
            },
            {
                "_x": 102.19662427902222,
                "_y": 174.7680652141571
            },
            {
                "_x": 113.35865139961243,
                "_y": 171.59908086061478
            },
            {
                "_x": 121.6722023487091,
                "_y": 168.23980271816254
            },
            {
                "_x": 37.28102922439575,
                "_y": 95.18345609307289
            },
            {
                "_x": 47.6105335354805,
                "_y": 94.81946602463722
            },
            {
                "_x": 60.97426652908325,
                "_y": 94.40573662519455
            },
            {
                "_x": 73.47347438335419,
                "_y": 100.0837491452694
            },
            {
                "_x": 62.635889649391174,
                "_y": 104.20162618160248
            },
            {
                "_x": 48.164643943309784,
                "_y": 102.30099096894264
            },
            {
                "_x": 131.75310015678406,
                "_y": 101.19264364242554
            },
            {
                "_x": 144.59157466888428,
                "_y": 96.10304474830627
            },
            {
                "_x": 159.18012619018555,
                "_y": 96.6294153034687
            },
            {
                "_x": 169.25851941108704,
                "_y": 99.28633153438568
            },
            {
                "_x": 158.41309309005737,
                "_y": 105.95053553581238
            },
            {
                "_x": 143.57456803321838,
                "_y": 104.84902784228325
            },
            {
                "_x": 59.62243854999542,
                "_y": 189.53802466392517
            },
            {
                "_x": 74.63513731956482,
                "_y": 189.61657404899597
            },
            {
                "_x": 93.2795923948288,
                "_y": 189.02506738901138
            },
            {
                "_x": 102.73819208145142,
                "_y": 190.98009288311005
            },
            {
                "_x": 111.32871627807617,
                "_y": 188.7206733226776
            },
            {
                "_x": 132.3192286491394,
                "_y": 191.4555537700653
            },
            {
                "_x": 148.1502389907837,
                "_y": 191.78031474351883
            },
            {
                "_x": 131.17528796195984,
                "_y": 205.65317273139954
            },
            {
                "_x": 117.77855277061462,
                "_y": 212.61069059371948
            },
            {
                "_x": 102.79188990592957,
                "_y": 214.37859892845154
            },
            {
                "_x": 89.73114967346191,
                "_y": 212.49166578054428
            },
            {
                "_x": 74.78313744068146,
                "_y": 205.44650942087173
            },
            {
                "_x": 61.65080010890961,
                "_y": 190.31138956546783
            },
            {
                "_x": 88.5330456495285,
                "_y": 194.68329817056656
            },
            {
                "_x": 102.61473953723907,
                "_y": 195.6598001718521
            },
            {
                "_x": 116.55294418334961,
                "_y": 195.50674438476562
            },
            {
                "_x": 145.1494812965393,
                "_y": 191.75870150327682
            },
            {
                "_x": 116.72505259513855,
                "_y": 201.31172329187393
            },
            {
                "_x": 103.34673464298248,
                "_y": 203.0391561985016
            },
            {
                "_x": 90.46184659004211,
                "_y": 201.6796651482582
            }
        ]
    },
    "alignedRect": {
        "_imageDims": {
            "_width": 640,
            "_height": 480
        },
        "_score": 0.9959298968315125,
        "_classScore": 0.9959298968315125,
        "_className": "",
        "_box": {
            "_x": 229.17177384346726,
            "_y": 213.0357283502817,
            "_width": 274.37042382359505,
            "_height": 217.54646462202075
        }
    },
    "angle": {
        "roll": 0,
        "pitch": -7,
        "yaw": 11
    },
    "expressions": {
        "neutral": 0.0004389471432659775,
        "happy": 0.977523684501648,
        "sad": 0.01572638750076294,
        "angry": 0.000031203446269501,
        "fearful": 9.56152803155419e-7,
        "disgusted": 0.006268579978495836,
        "surprised": 0.000010172513611905742
    },
    "gender": "male",
    "genderProbability": 0.9819888472557068,
    "age": 45.649803161621094
}
*/
